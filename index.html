<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>RadarEG</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html,body,#map{height:100%;margin:0;font-family:Arial}
#map{z-index:1}

/* Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø« */
#search{
position:fixed;top:10px;left:50%;transform:translateX(-50%);
background:#000;padding:6px;border-radius:12px;z-index:1000;
display:flex;gap:6px
}
#search input{padding:6px;border-radius:8px;border:0;width:180px}
#search button{padding:6px 10px;border:0;border-radius:8px;background:#00c853;color:#fff}

/* Ù„ÙˆØ­Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª */
#dashboard{
position:fixed;bottom:10px;left:50%;transform:translateX(-50%);
background:#000;color:#fff;border-radius:18px;
padding:14px 22px;z-index:999;text-align:center;
min-width:300px
}
#speed{font-size:38px;font-weight:bold}
#stats{font-size:16px;margin-top:6px;opacity:.9}
#startBtn{
margin-top:10px;padding:10px 18px;border-radius:14px;
border:0;background:#00c853;color:#fff;font-size:16px
}
</style>
</head>

<body>

<div id="search">
  <input id="address" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">
  <button onclick="go()">Ø§Ø°Ù‡Ø¨</button>
</div>

<div id="map"></div>

<div id="dashboard">
  <div id="speed">0 ÙƒÙ…/Ø³</div>
  <div id="stats">â€” ÙƒÙ… â€¢ â€” Ø¯Ù‚ÙŠÙ‚Ø©</div>
  <button id="startBtn" onclick="start()">ğŸ“ Ø¨Ø¯Ø¡ Ø§Ù„ØªØªØ¨Ø¹</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* =====================
   Ø±Ø§Ø¯Ø§Ø±Ø§Øª (ØªØ­Ø°ÙŠØ±ÙŠÙ†)
===================== */
const RADARS=[
{lat:30.0444,lng:31.2357,speed:60,warn1:false,warn2:false},
{lat:30.0131,lng:31.2089,speed:90,warn1:false,warn2:false},
{lat:30.0870,lng:31.3301,speed:120,warn1:false,warn2:false}
];

/* =====================
   Ø§Ù„Ø®Ø±ÙŠØ·Ø©
===================== */
const map=L.map("map").setView([30.0444,31.2357],13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);

RADARS.forEach(r=>{
L.marker([r.lat,r.lng]).addTo(map)
.bindPopup(`ğŸ“¡ Ø±Ø§Ø¯Ø§Ø±<br>Ø§Ù„Ø³Ø±Ø¹Ø© ${r.speed} ÙƒÙ…/Ø³`);
});

/* =====================
   Ù…ÙˆÙ‚Ø¹Ùƒ
===================== */
const user=L.circleMarker([0,0],{
radius:9,color:"blue",fillColor:"blue",fillOpacity:1
}).addTo(map);

let userPos=null, routeLine=null;
let routeDistance=0, routeDuration=0;
let moved=false;

/* =====================
   ØµÙˆØª + Ø§Ù‡ØªØ²Ø§Ø²
===================== */
function unlockAudio(){
  const u=new SpeechSynthesisUtterance(" ");
  u.lang="ar-EG";
  speechSynthesis.speak(u);
}
function speak(t){
  if(!("speechSynthesis" in window)) return;
  const u=new SpeechSynthesisUtterance(t);
  u.lang="ar-EG";
  u.rate=1;
  u.volume=1;
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}
function vibrate(){
  if("vibrate" in navigator){
    navigator.vibrate([300,150,300]);
  }
}

/* =====================
   Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©
===================== */
function distance(a,b,c,d){
const R=6371000;
const dLat=(c-a)*Math.PI/180;
const dLon=(d-b)*Math.PI/180;
const x=Math.sin(dLat/2)**2+
Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*
Math.sin(dLon/2)**2;
return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}

/* =====================
   ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹
===================== */
function start(){
unlockAudio();
navigator.geolocation.watchPosition(onLocation,onError,{
enableHighAccuracy:true,maximumAge:0,timeout:10000
});
document.getElementById("startBtn").style.display="none";
}

function onLocation(p){
const lat=p.coords.latitude;
const lng=p.coords.longitude;
const speed=(p.coords.speed||0)*3.6;

userPos=[lat,lng];
user.setLatLng(userPos);

if(!moved){
  map.setView(userPos,16);
  moved=true;
}

document.getElementById("speed").innerText=
`${speed.toFixed(0)} ÙƒÙ…/Ø³`;

if(routeDistance){
document.getElementById("stats").innerText=
`${(routeDistance/1000).toFixed(1)} ÙƒÙ… â€¢ ${Math.round(routeDuration/60)} Ø¯Ù‚ÙŠÙ‚Ø©`;
}

/* ===== Ø±Ø§Ø¯Ø§Ø±Ø§Øª (Ù…Ø¶Ù…ÙˆÙ†Ø©) ===== */
RADARS.forEach(r=>{
const d=distance(lat,lng,r.lat,r.lng);

if(d<=1500 && !r.warn1){
r.warn1=true;
speak(`ØªÙ†Ø¨ÙŠÙ‡ØŒ Ø±Ø§Ø¯Ø§Ø± Ø³Ø±Ø¹Ø© Ø¨Ø¹Ø¯ ${Math.round(d)} Ù…ØªØ±`);
vibrate();
}

if(d<=500 && !r.warn2){
r.warn2=true;
speak("Ø§Ù†Øª Ù‚Ø±ÙŠØ¨ Ø¬Ø¯Ù‹Ø§ Ù…Ù† Ø§Ù„Ø±Ø§Ø¯Ø§Ø±");
vibrate();
}

if(d>2000){
r.warn1=false;
r.warn2=false;
}
});
}

function onError(){
alert("ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„ GPS ÙˆØ§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù…ÙˆÙ‚Ø¹");
}

/* =====================
   Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø©
===================== */
function go(){
if(!userPos) return alert("Ø´ØºÙ‘Ù„ Ø§Ù„ØªØªØ¨Ø¹ Ø§Ù„Ø£ÙˆÙ„");
const q=document.getElementById("address").value.trim();
if(!q) return;

fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`)
.then(r=>r.json())
.then(d=>{
if(!d.length) return alert("Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ØºÙŠØ± ÙˆØ§Ø¶Ø­");
drawRoute(userPos,[+d[0].lat,+d[0].lon]);
});
}

function drawRoute(start,end){
fetch(`https://router.project-osrm.org/route/v1/driving/${start[1]},${start[0]};${end[1]},${end[0]}?overview=full&geometries=geojson`)
.then(r=>r.json())
.then(data=>{
const r=data.routes[0];
routeDistance=r.distance;
routeDuration=r.duration;
const coords=r.geometry.coordinates.map(c=>[c[1],c[0]]);
if(routeLine) map.removeLayer(routeLine);
routeLine=L.polyline(coords,{color:"green",weight:6}).addTo(map);
map.fitBounds(routeLine.getBounds());
});
}

/* =====================
   Service Worker
===================== */
if("serviceWorker"in navigator){
navigator.serviceWorker.register("pwabuilder-sw.js");
}
</script>

</body>
</html>
