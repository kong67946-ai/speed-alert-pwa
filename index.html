
<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Speed Alert Navigator</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#16a34a">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body{margin:0;background:#020617;color:#fff;font-family:Arial}
#top{padding:10px;background:#020617}
#speed{font-size:42px;font-weight:bold}
#alert{display:none;background:#dc2626;padding:8px;font-size:18px}
#map{height:65vh}
#controls{padding:10px}
button{padding:10px 16px;font-size:16px;border:0;border-radius:6px;background:#16a34a;color:#fff}
</style>
</head>

<body>

<div id="top">
السرعة الحالية
<div id="speed">0</div>
</div>

<div id="alert">⚠️ تجاوزت السرعة المسموحة</div>
<div id="map"></div>

<div id="controls">
<button onclick="start()">تشغيل التتبع</button>
</div>

<audio id="beep">
<source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg">
</audio>

<script>
const SPEED_LIMIT = 60;
const RADAR_RADIUS = 1000;

let map = L.map("map").setView([30.0444,31.2357],14);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

let marker, radarCircle, alerted=false;

const radarIcon = L.icon({
  iconUrl: "https://cdn-icons-png.flaticon.com/512/483/483361.png",
  iconSize:[32,32]
});

function speak(t){
 let u=new SpeechSynthesisUtterance(t);
 u.lang="ar-EG";
 speechSynthesis.speak(u);
}

function loadRadars(lat,lng){
 let url=`https://overpass-api.de/api/interpreter?data=
 [out:json];
 node["highway"="speed_camera"](around:${RADAR_RADIUS},${lat},${lng});
 out;`;
 fetch(url)
 .then(r=>r.json())
 .then(d=>{
  d.elements.forEach(c=>{
   L.marker([c.lat,c.lon],{icon:radarIcon}).addTo(map);
  });
 });
}

function drawRoute(lat,lng){
 let destLat=lat+0.01;
 let destLng=lng+0.01;
 fetch(`https://router.project-osrm.org/route/v1/driving/${lng},${lat};${destLng},${destLat}?overview=full&geometries=geojson`)
 .then(r=>r.json())
 .then(d=>{
  let coords=d.routes[0].geometry.coordinates.map(c=>[c[1],c[0]]);
  L.polyline(coords,{color:"blue"}).addTo(map);
 });
}

function start(){
 if(!navigator.geolocation){alert("GPS غير مدعوم");return;}
 navigator.geolocation.watchPosition(p=>{
  let lat=p.coords.latitude;
  let lng=p.coords.longitude;
  let speed=Math.round((p.coords.speed||0)*3.6);
  document.getElementById("speed").innerText=speed;

  if(!marker){
    marker=L.marker([lat,lng]).addTo(map);
    radarCircle=L.circle([lat,lng],{radius:RADAR_RADIUS,color:"red"}).addTo(map);
    loadRadars(lat,lng);
    drawRoute(lat,lng);
  }else{
    marker.setLatLng([lat,lng]);
    radarCircle.setLatLng([lat,lng]);
  }

  map.setView([lat,lng],16);

  if(speed>SPEED_LIMIT){
    if(!alerted){
      document.getElementById("alert").style.display="block";
      document.getElementById("beep").play();
      speak("انت متجاوز السرعة");
      alerted=true;
    }
  }else{
    document.getElementById("alert").style.display="none";
    alerted=false;
  }

 },e=>alert("فعّل GPS"),{enableHighAccuracy:true});
}

if("serviceWorker" in navigator){
 navigator.serviceWorker.register("sw.js");
}
</script>

</body>
</html>
