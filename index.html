
<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>All-In-One Navigator</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body{margin:0;font-family:Arial;background:#0f172a;color:#fff}
#top{background:#111827;padding:10px;text-align:center}
#speed{font-size:42px;font-weight:bold}
#alert{background:#dc2626;padding:8px;text-align:center;display:none}
#map{height:60vh}
#controls{background:#020617;padding:10px;text-align:center}
input,button{padding:10px;font-size:16px;border-radius:8px;border:none;margin:5px}
button{background:#22c55e}
</style>
</head>

<body>

<div id="top">
  السرعة الحالية
  <div id="speed">0</div>
  كم/س
</div>

<div id="alert">⚠️ تجاوزت السرعة – رادار قريب</div>

<div id="map"></div>

<div id="controls">
  <input id="dest" placeholder="اكتب وجهتك" />
  <button onclick="startNav()">ابدأ التوجيه</button>
</div>

<audio id="beep">
  <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg">
</audio>

<script>
/* ===== إعدادات ===== */
const SPEED_LIMIT = 60;
const RADAR_RADIUS = 1000;

/* ===== متغيرات ===== */
let map = L.map("map").setView([30,31],6);
let marker, radarCircle, routeLine;
let currentPos = null;
let alerted = false;

/* ===== خريطة ===== */
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19
}).addTo(map);

/* ===== GPS مباشر ===== */
navigator.geolocation.watchPosition(pos=>{
  const lat = pos.coords.latitude;
  const lng = pos.coords.longitude;
  currentPos = [lat,lng];

  const speed = Math.round((pos.coords.speed || 0) * 3.6);
  document.getElementById("speed").innerText = speed;

  if(!marker){
    marker = L.marker(currentPos).addTo(map);
    radarCircle = L.circle(currentPos,{
      radius: RADAR_RADIUS,
      color: "red",
      fillOpacity: 0.3
    }).addTo(map);
    map.setView(currentPos,16);
  }else{
    marker.setLatLng(currentPos);
    radarCircle.setLatLng(currentPos);
    map.panTo(currentPos);
  }

  if(speed > SPEED_LIMIT){
    document.getElementById("alert").style.display="block";
    if(!alerted){
      document.getElementById("beep").play();
      speak("انت متجاوز السرعة المسموح بها");
      alerted = true;
    }
  }else{
    document.getElementById("alert").style.display="none";
    alerted = false;
  }
},{enableHighAccuracy:true});

/* ===== صوت كلام ===== */
function speak(text){
  const s = new SpeechSynthesisUtterance(text);
  s.lang = "ar-EG";
  speechSynthesis.speak(s);
}

/* ===== نظام التوجيه ===== */
async function startNav(){
  if(!currentPos) return;

  const q = document.getElementById("dest").value;
  if(!q) return;

  const geo = await fetch(
    `https://nominatim.openstreetmap.org/search?format=json&q=${q}`
  ).then(r=>r.json());

  if(!geo.length) return;

  const dest = [geo[0].lat, geo[0].lon];

  const data = await fetch(
    `https://router.project-osrm.org/route/v1/driving/${currentPos[1]},${currentPos[0]};${dest[1]},${dest[0]}?overview=full&geometries=geojson`
  ).then(r=>r.json());

  const coords = data.routes[0].geometry.coordinates.map(c=>[c[1],c[0]]);

  if(routeLine) map.removeLayer(routeLine);
  routeLine = L.polyline(coords,{color:"lime",weight:5}).addTo(map);
  map.fitBounds(routeLine.getBounds());

  speak("تم بدء التوجيه");
}
</script>

</body>
</html>
